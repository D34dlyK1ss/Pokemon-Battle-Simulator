<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Who is it?™ Online</title>
		<link rel="stylesheet" href="css/index.css"/>
	</head>

	<body>
		<h1>Who is it?™ Online</h1>
		<button id="btnCreateGame">New Game</button>
		<br>
		<button id="btnJoinGame">Join Game</button>
		<input type="text" id="txtJoinGame" />
		<br>
		<button id="btnLeaveGame">Leave Game</button>
		<br>
		<p id="roomCode"></p>
		<div id="divPlayers"></div>
		<div id="divBoard"></div>

		<script>
			let myClientId = null;
			let gameId = null;
			let ws = new WebSocket("ws://localhost:9090");

			// HTML Elements
			const btnCreateGame = document.getElementById("btnCreateGame");
			const btnJoinGame = document.getElementById("btnJoinGame");
			const txtJoinGame = document.getElementById("txtJoinGame");
			const btnLeaveGame = document.getElementById("btnLeaveGame");
			const roomCode = document.getElementById("roomCode");
			const divPlayers = document.getElementById("divPlayers");
			const divBoard = document.getElementById("divBoard");

			// Event listeners
			btnCreateGame.addEventListener("click", () => {
				const payload = {
					"method": "createGame",
					"clientId": myClientId
				}

				ws.send(JSON.stringify(payload));
			});

			btnJoinGame.addEventListener("click", () => {
				joinGame();
			});

			btnLeaveGame.addEventListener("click", () => {
				while (divPlayers.firstChild) divPlayers.removeChild(divPlayers.firstChild);

				roomCode.innerHTML = '';

				const payload = {
					"method": "leaveGame",
					"clientId": myClientId,
					"gameId": gameId
				}

				ws.send(JSON.stringify(payload));
				gameId = null;
			});

			// When server responds
			ws.onmessage = message => {
				const response = JSON.parse(message.data);

				// Connecting
				if (response.method === "connect") {
					myClientId = response.clientId;
				}

				if (response.method === "createGame") {
					gameId = response.game.id;
					joinGame();
				}

				if (response.method === "joinGame") {
					while (divPlayers.firstChild) divPlayers.removeChild(divPlayers.firstChild);

					let i = 0;
					response.game.players.forEach(player => {
						const div = document.createElement("div");

						div.innerHTML = `<b>Player ${++i}: </b>${player.clientId}`;
						divPlayers.appendChild(div);
					});

					roomCode.innerHTML = `<b>Room code: </b>${response.game.id}`;
				}

				if (response.method === "leaveGame") {
					while (divPlayers.firstChild) divPlayers.removeChild(divPlayers.firstChild);

					let i = 0;
					response.game.players.forEach(player => {
						const div = document.createElement("div");

						div.innerHTML = `<b>Player ${++i}: </b>${player.clientId}`;
						divPlayers.appendChild(div);
					});
				}

				if (response.method === "error") {
					alert(response.message);
				}

			}

			function joinGame() {
				if (!gameId) gameId = txtJoinGame.value;

				const payload = {
					"method": "joinGame",
					"clientId": myClientId,
					"gameId": gameId
				}

				ws.send(JSON.stringify(payload));
			}

		</script>
	</body>

</html>