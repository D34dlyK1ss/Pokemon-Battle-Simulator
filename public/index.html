<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Who is it?™ Online</title>
		<link rel="stylesheet" href="css/index.css" />
	</head>

	<body>
		<h1>Who is it?™ Online</h1>
		<button id="btnCreateGame">New Game</button>
		<br>
		<button id="btnJoinGame">Join Game</button>
		<input type="text" id="txtJoinGame" />
		<br>
		<button id="btnLeaveGame">Leave Game</button>
		<br>
		<p id="roomCode"></p>
		<div id="divPlayers"></div>
		<div id="divBoard"></div>

		<script>
			let myClientId = null;
			let gameId = null;
			let ws = new WebSocket("ws://localhost:9090");

			// HTML Elements
			const btnCreateGame = document.getElementById("btnCreateGame");
			const btnJoinGame = document.getElementById("btnJoinGame");
			const txtJoinGame = document.getElementById("txtJoinGame");
			const btnLeaveGame = document.getElementById("btnLeaveGame");
			const roomCode = document.getElementById("roomCode");
			const divPlayers = document.getElementById("divPlayers");
			const divBoard = document.getElementById("divBoard");

			// Event listeners
			btnCreateGame.addEventListener("click", () => {
				const payload = {
					"method": "createGame",
					"clientId": myClientId
				}

				ws.send(JSON.stringify(payload));
			});

			btnJoinGame.addEventListener("click", () => {
				if (!txtJoinGame.value) return alert("Please type a room code into the text box.");

				joinGame(txtJoinGame.value);
			});

			btnLeaveGame.addEventListener("click", () => {
				const payload = {
					"method": "leaveGame",
					"clientId": myClientId,
					"gameId": gameId
				}

				ws.send(JSON.stringify(payload));
				roomCode.innerHTML = '';
				gameId = null;

				while (divPlayers.firstChild) divPlayers.removeChild(divPlayers.firstChild);
			});

			// When server responds
			ws.onmessage = message => {
				const response = JSON.parse(message.data)

				if (response.method === "error") {
					alert(response.message);
					return;
				}

				// Connecting
				if (response.method === "connect") {
					myClientId = response.clientId;
					return;
				}

				// Creating a game
				if (response.method === "createGame") {
					joinGame(response.gameId);
					return;
				}

				// Joining a game
				if (response.method === "joinGame") {
					gameId = response.game.id;
					roomCode.innerHTML = `<b>Room code: </b>${gameId}`;
					updatePlayers(response.game.players);
					return;
				}

				// A player left the game
				if (response.method === "playerLeft") {
					console.log(response.game.players);
					updatePlayers(response.game.players)
					return;
				}
			}

			function joinGame(_gameId) {
				const payload = {
					"method": "joinGame",
					"clientId": myClientId,
					"gameId": _gameId
				}

				ws.send(JSON.stringify(payload));
			}

			function updatePlayers(_arrayPlayers) {
				while (divPlayers.firstChild) divPlayers.removeChild(divPlayers.firstChild);

				let i = 0;
				
				_arrayPlayers.forEach(player => {
					const div = document.createElement("div");
					const text = player.clientId === myClientId ? `<b>You</b>` : player.clientId;

					div.innerHTML = `<b>Player ${++i}: </b>${text}`;
					divPlayers.appendChild(div);
				});
			}

		</script>
	</body>

</html>